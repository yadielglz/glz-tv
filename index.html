<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="application-name" content="GLZ TV">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GLZ TV">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="msapplication-TileColor" content="#1b1f2f">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#1b1f2f">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.js"></script>
  <title>GLZ TV</title>
</head>
<body data-theme="dark">
  <div class="app-surface">
    <div class="bg-grid"></div>
    <div class="status-message" id="status-message"></div>

    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-logo">GLZ TV</div>
        <span class="badge live-pill">Live</span>
      </div>
      <div class="topbar-center">
        <div class="time-block">
          <div class="time-display" id="desktop-time-display">--:--</div>
          <div class="time-display mobile-only" id="mobile-time-display">--:--</div>
          <div class="date-display" id="date-display">--</div>
        </div>
      </div>
      <div class="topbar-actions">
        <button class="icon-btn" id="desktop-sidebar-toggle-btn" title="Channel guide">
          <span class="icon">‚ò∞</span>
        </button>
        <button class="icon-btn" id="mini-guide-toggle" title="Mini guide">
          <span class="icon">‚åó</span>
        </button>
        <button class="icon-btn" id="desktop-header-options-btn" title="Settings">
          <span class="icon">‚öô</span>
        </button>
        <button class="icon-btn danger" id="desktop-power-btn" title="Power">
          <span class="icon">‚èª</span>
        </button>
        <button class="icon-btn ghost mobile-only" id="mobile-sidebar-toggle-btn" title="Channels">
          <span class="icon">‚ò∞</span>
        </button>
        <button class="icon-btn ghost mobile-only" id="mobile-header-options-btn" title="Settings">
          <span class="icon">‚öô</span>
        </button>
        <button class="icon-btn ghost mobile-only" id="mobile-power-btn" title="Power">
          <span class="icon">‚èª</span>
        </button>
        <button class="icon-btn ghost sr-only" id="header-options-btn" aria-label="Legacy settings"></button>
        <button class="icon-btn ghost sr-only" id="power-btn" aria-label="Legacy power"></button>
      </div>
    </header>

    <main class="layout-grid">
      <section class="player-stack">
        <div class="desktop-video-section">
          <div class="desktop-video-container" id="desktop-video-container">
            <video id="desktop-video" controls autoplay playsinline>
              Your browser does not support the video tag.
            </video>
            <audio id="desktop-audio" controls autoplay>
              Your browser does not support the audio tag.
            </audio>
            <div class="loading-indicator" id="desktop-loading-indicator">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading channel...</div>
            </div>
            <div class="channel-overlay glass" id="channel-banner">
              <div class="overlay-top">
                <div class="channel-logo-wrap">
                  <img id="channel-logo-img" alt="Channel logo">
                  <div id="channel-logo-placeholder">TV</div>
                </div>
                <div class="overlay-meta">
                  <div class="channel-number" id="desktop-weather-channel-number">--</div>
                  <div class="channel-name" id="desktop-weather-channel-name">Select Channel</div>
                  <div class="program-line" id="current-program">Waiting for program info</div>
                </div>
                <span class="badge subtle" id="connection-status-display">Online</span>
              </div>
              <div class="overlay-progress">
                <div class="progress-track">
                  <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="next-up" id="banner-name">Next up ‚Ä¢ --</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mobile-video-panel mobile-only">
          <div class="mobile-video-container" id="mobile-video-container">
            <video id="mobile-video" controls autoplay playsinline>
              Your browser does not support the video tag.
            </video>
            <audio id="mobile-audio" controls autoplay>
              Your browser does not support the audio tag.
            </audio>
            <div class="loading-indicator" id="mobile-loading-indicator">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading channel...</div>
            </div>
          </div>
          <div class="mobile-now">
            <div class="mobile-channel-number" id="mobile-channel-number">--</div>
            <div class="mobile-channel-info">
              <div class="mobile-channel-name" id="mobile-channel-name">Select Channel</div>
              <div class="mobile-program" id="mobile-current-program">Waiting for program info</div>
            </div>
            <button class="pill-btn" id="mobile-channel-toggle">Guide</button>
          </div>
          <div class="mobile-channel-list-section" id="mobile-channel-list-section">
            <div class="mobile-channel-list" id="mobile-channel-list"></div>
          </div>
        </div>

        <div class="info-row">
          <div class="now-card glass">
            <div class="now-head">
              <div class="pill">Now Playing</div>
              <div class="epg-quick" id="epg-info">EPG loading‚Ä¶</div>
            </div>
            <div class="now-body">
              <div class="channel-number tiny" id="channel-number">--</div>
              <div class="now-text">
                <div class="channel-name" id="channel-name">Select Channel</div>
                <div class="program-line" id="banner-channel">---</div>
              </div>
            </div>
          </div>

          <div class="weather-card glass desktop-only" id="desktop-weather-bar">
            <div class="weather-left">
              <div class="weather-icon" id="desktop-weather-icon">üå§Ô∏è</div>
              <div class="weather-temp" id="desktop-weather-temp">--¬∞</div>
              <div class="weather-location" id="desktop-weather-location">Loading‚Ä¶</div>
            </div>
            <div class="weather-right">
              <div class="forecast" id="desktop-weather-forecast"></div>
            </div>
          </div>
        </div>
      </section>

      <aside class="guide-panel">
        <div class="desktop-sidebar open" id="desktop-sidebar">
          <div class="desktop-sidebar-header">
            <div>
              <p class="eyebrow">Channel guide</p>
              <h2 class="desktop-sidebar-title">All Channels</h2>
            </div>
            <div class="sidebar-actions">
              <button class="icon-btn ghost" id="desktop-close-sidebar-btn" title="Close">√ó</button>
            </div>
          </div>
          <div class="search-row">
            <input id="search-input" type="search" placeholder="Search channels‚Ä¶">
            <button class="pill-btn" id="clear-cache-inline">Clear Cache</button>
          </div>
          <div class="desktop-channel-list" id="desktop-channel-list"></div>
        </div>
      </aside>
    </main>

    <div class="options-overlay" id="options-overlay">
      <div class="options-panel glass">
        <div class="options-header">
          <h3>Quick Controls</h3>
          <button class="icon-btn ghost" id="close-options">√ó</button>
        </div>
        <div class="options-grid">
          <div class="option">
            <label>Theme</label>
            <button class="toggle-btn" id="theme-toggle-btn" type="button">
              <svg class="toggle-icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
              <span id="theme-toggle-text">Dark Mode</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="mini-guide" id="mini-guide">
      <div class="mini-guide-header">
        <div>
          <p class="eyebrow">Quick browse</p>
          <h3>Mini Guide</h3>
        </div>
        <button class="icon-btn ghost" id="mini-guide-close">√ó</button>
      </div>
      <div class="mini-guide-content" id="mini-guide-content"></div>
    </div>

    <div class="help-overlay" id="help-overlay">
      <div class="help-panel glass">
        <div class="help-header">
          <h3>Shortcuts</h3>
          <button class="icon-btn ghost" id="close-help">√ó</button>
        </div>
        <div class="help-body" id="help-body">
          <p>F3 opens quick options. Arrow keys change channels. Numbers jump directly.</p>
        </div>
      </div>
    </div>

    <div class="settings-overlay" id="settings-overlay">
      <div class="settings-content glass">
        <div class="settings-header">
          <h2>Settings</h2>
          <button class="icon-btn ghost" id="close-settings">√ó</button>
        </div>
        <div class="settings-body">
          <div class="settings-section">
            <h3>Theme</h3>
            <div class="setting-item">
              <label for="theme-select">Theme mode</label>
              <select id="theme-select">
                <option value="auto">Auto</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
          </div>

          <div class="settings-section">
            <h3>Cache & Storage</h3>
            <div class="setting-item">
              <label>Clear cache</label>
              <button class="pill-btn" id="clear-cache-btn">Clear</button>
            </div>
            <div class="setting-item">
              <label>Last channel</label>
              <span id="last-channel-display">None</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Weather</h3>
            <div class="setting-item">
              <label for="weather-location-input">Location</label>
              <input type="text" id="weather-location-input" placeholder="City">
              <button class="pill-btn" id="update-weather-btn">Update</button>
            </div>
            <div class="setting-item">
              <label for="weather-units-select">Units</label>
              <select id="weather-units-select">
                <option value="metric">Celsius (¬∞C)</option>
                <option value="imperial">Fahrenheit (¬∞F)</option>
              </select>
            </div>
          </div>

          <div class="settings-section">
            <h3>About</h3>
            <div class="setting-item">
              <label>Version</label>
              <span>GLZ TV v1.0</span>
            </div>
            <div class="setting-item">
              <label>Channels</label>
              <span id="channel-count-display">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="standby-screen show" id="standby-screen">
      <div class="standby-content">
        <div class="standby-logo">GLZ TV</div>
        <div class="standby-text">Click to power on</div>
      </div>
    </div>

    <div class="remote-control" id="remote-control"></div>

    <div class="sr-only" id="mobile-options-btn"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script src="app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js');
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('New version available! Reload to update?')) {
                  window.location.reload();
                }
              }
            });
          });
        } catch (error) {
          console.error('Service Worker registration failed:', error);
        }
      });
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (confirm('Install GLZ TV for a faster launch?')) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => deferredPrompt = null);
      }
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
    });

    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    if (action === 'guide') {
      window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          const btn = document.getElementById('desktop-sidebar-toggle-btn');
          if (btn) btn.click();
        }, 800);
      });
    } else if (action === 'settings') {
      window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          const btn = document.getElementById('desktop-header-options-btn') || document.getElementById('header-options-btn');
          if (btn) btn.click();
        }, 800);
      });
    }
  </script>
</body>
</html>
