<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Glz Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Segoe+UI+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        /* --- [Core styles are preserved from the previous version] --- */
        :root { /* Default: Dark Theme */ --bg-color: #1a1a1a; --text-color: #ffffff; --text-muted-color: #b0b0b0; --text-faint-color: #555555; --surface-color: rgba(43, 43, 43, 0.85); --border-color: rgba(74, 74, 74, 0.5); --modal-bg: #1a1a1a; --play-button-bg: #00a3e0; --play-button-text: #ffffff; --accent-color: #00a3e0; --player-text-shadow: 1px 1px 5px rgba(0,0,0,0.7); }
        .theme-light { /* Light Theme */ --bg-color: #F7F2FA; --text-color: #1D1B20; --text-muted-color: #48464C; --text-faint-color: #79767D; --surface-color: rgba(231, 222, 237, 0.85); --border-color: rgba(202, 196, 208, 0.5); --modal-bg: #F7F2FA; --player-text-shadow: 1px 1px 3px rgba(0,0,0,0.25); }
        .theme-oled { /* OLED "Super Dark" Theme */ --bg-color: #000000; --text-color: #ffffff; --text-muted-color: #a0a0a0; --text-faint-color: #444444; --surface-color: rgba(20, 20, 20, 0.85); --border-color: rgba(50, 50, 50, 0.5); --modal-bg: #000000; }
        body, .font-sans { font-family: 'Inter', 'Segoe UI', sans-serif; }
        .font-mono { font-family: 'Segoe UI Mono', monospace; }
        .station-list-scrollbar::-webkit-scrollbar { width: 8px; }
        .station-list-scrollbar::-webkit-scrollbar-track { background: var(--surface-color); }
        .station-list-scrollbar::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        #player-display { background: black; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: all 0.4s ease-in-out; height: 200px; }
        #station-list-in-options { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #station-list-in-options.expanded { max-height: 250px; overflow-y: auto; }
        .station-item:hover, .station-item.selected { background-color: var(--accent-color) !important; color: var(--play-button-text) !important; }
        .station-item:hover p, .station-item.selected p { color: var(--play-button-text) !important; }
        #tuner-panel { background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03)); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-top: 1px solid rgba(255, 255, 255, 0.15); border-bottom: 1px solid rgba(255, 255, 255, 0.15); }
        #options-modal, #m3u-modal { transition: visibility 0.3s; }
        #options-modal.hidden, #m3u-modal.hidden { visibility: hidden; }
        #options-backdrop, #m3u-backdrop { transition: opacity 0.3s ease-in-out; }
        #options-panel, #m3u-panel { transition: transform 0.3s ease-in-out; }
        #options-modal.is-open #options-backdrop, #m3u-modal.is-open #m3u-backdrop { opacity: 1; }
        #options-modal.is-open #options-panel { transform: translateX(0); }
        #m3u-modal.is-open #m3u-panel { transform: translateY(0) scale(1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #splash-screen { background-color: var(--bg-color); transition: opacity 0.75s ease-out, visibility 0.75s ease-out; }
        @keyframes splash-pop-in { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        #splash-content { animation: splash-pop-in 0.8s ease-out forwards; }
        #splash-logo { filter: drop-shadow(0 0 15px var(--accent-color)); }
        #ambient-bg { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; filter: blur(50px) brightness(0.6); transform: scale(1.2); transition: opacity 1000ms ease-in-out; z-index: 0; }
        #top-bar, #tuner-container, main, #bottom-bar { z-index: 1; transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        #controls-container button { transition: all 0.2s ease-out; }
        #play-button, #stop-button { will-change: transform, opacity; transition: transform 0.3s ease, opacity 0.3s ease; }
        #play-button.hidden, #stop-button.hidden { transform: scale(0.5); opacity: 0; pointer-events: none; }
        #app-container.options-open > #top-bar, #app-container.options-open > #tuner-container, #app-container.options-open > main, #app-container.options-open > #bottom-bar { transform: scale(0.97); filter: blur(3px); opacity: 0.7; pointer-events: none; }
        #video-player { width: 100%; height: 100%; background-color: #000; }
        #tuner-content.video-mode { display: flex; align-items: center; justify-content: center; gap: 0.75rem; color: var(--accent-color); filter: drop-shadow(0 0 5px var(--accent-color)); }
        #load-playlist-btn.loading { cursor: not-allowed; opacity: 0.7; }
        .loader-dots div { animation: loader-pulse 1.4s infinite ease-in-out; animation-fill-mode: both; }
        .loader-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loader-dots div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loader-pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="w-full h-full font-sans bg-[var(--bg-color)] text-[var(--text-color)] transition-colors duration-300">

    <div id="splash-screen" class="fixed inset-0 z-[100] flex items-center justify-center">
        <div id="splash-content" class="text-center">
             <svg id="splash-logo" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-[var(--accent-color)] mx-auto">
                 <path d="M16 12.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0z" stroke="currentColor" stroke-width="1.5" />
                 <path d="M21.17 8.83l-2.27-2.27A10.15 10.15 0 0 0 12 2C6.86 2 2.73 5.64 2.1 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M2.83 15.17l2.27 2.27A10.15 10.15 0 0 0 12 22c5.14 0 9.27-3.64 9.9-8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-3xl font-bold text-[var(--text-color)] tracking-widest mt-4">Glz Player</h1>
            <p class="text-[var(--text-muted-color)] mt-1">Ready to play...</p>
        </div>
    </div>
    
    <div class="w-full h-full flex justify-center items-center p-0 sm:p-4">
        <div id="app-container" class="w-full h-full sm:max-w-xl sm:h-auto sm:max-h-[95vh] sm:rounded-2xl sm:shadow-2xl flex flex-col bg-[var(--bg-color)] transition-colors duration-300 relative overflow-hidden">
            
            <div id="ambient-bg"></div>

            <header id="top-bar" class="w-full p-3 flex justify-between items-center text-[var(--text-color)] z-20 bg-transparent flex-shrink-0">
                <div id="status-left" class="w-1/3 text-left flex items-center h-full"></div>
                <div id="status-center" class="w-1/3 text-center font-bold text-sm"></div>
                <div id="status-right" class="w-1/3 flex justify-end"></div>
            </header>

            <div id="tuner-container" class="w-full flex-shrink-0 mb-4">
                <div id="tuner-panel" class="w-full h-12 flex items-center p-2 relative">
                    <div id="tuner-content" class="w-full h-full flex items-center z-10 opacity-0 transition-opacity duration-300">
                        </div>
                </div>
            </div>

            <main class="z-10 w-full px-4 flex flex-col items-center space-y-4 flex-grow justify-center bg-transparent">
                <div id="player-display" class="w-full rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <div id="player-content" class="w-full h-full flex items-center justify-center text-center">
                        <i data-lucide="tv" class="w-16 h-16 text-[var(--text-faint-color)]"></i>
                    </div>
                </div>
                <div id="controls-container" class="w-full flex items-center justify-center space-x-4 flex-shrink-0">
                    <button id="options-button" class="bg-[var(--surface-color)] p-4 rounded-full text-[var(--text-color)] hover:bg-[var(--border-color)] transition-all duration-200 border border-[var(--border-color)]" aria-label="Open options">
                        <i data-lucide="settings-2" class="w-7 h-7"></i>
                    </button>
                    <button id="play-button" class="bg-[var(--play-button-bg)] text-[var(--play-button-text)] p-5 rounded-full shadow-lg hover:opacity-90 transform hover:scale-105" aria-label="Play">
                        <i data-lucide="play" class="w-10 h-10 fill-current ml-1"></i>
                    </button>
                    <button id="stop-button" class="hidden bg-red-600 text-white p-5 rounded-full shadow-lg hover:bg-red-700 transform hover:scale-105" aria-label="Stop player">
                        <i data-lucide="square" class="w-10 h-10 fill-current"></i>
                    </button>
                    <button id="load-m3u-button" class="bg-[var(--surface-color)] p-4 rounded-full text-[var(--text-color)] hover:bg-[var(--border-color)] transition-all duration-200 border border-[var(--border-color)]" aria-label="Load M3U Playlist">
                        <i data-lucide="list-plus" class="w-7 h-7"></i>
                    </button>
                </div>
            </main>
            
            <footer id="bottom-bar" class="w-full p-3 flex justify-between items-center text-[var(--text-color)] z-20 bg-transparent flex-shrink-0">
                 <span id="bottom-bar-station-name" class="font-bold text-sm h-5 truncate"></span>
            </footer>

            <div id="modals-container">
                <div id="m3u-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div id="m3u-backdrop" class="absolute inset-0 bg-black/50 transition-opacity duration-300 opacity-0"></div>
                    <div id="m3u-panel" class="relative w-full max-w-md bg-[var(--modal-bg)] rounded-2xl shadow-xl transform scale-95 -translate-y-10 transition-transform duration-300 ease-out">
                         <header class="flex items-center justify-between p-4 border-b border-[var(--border-color)]">
                            <h2 class="text-xl font-bold text-[var(--text-color)]">Load Playlist & EPG</h2>
                            <button id="close-m3u-button" class="p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-color)]">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </header>
                        <div class="p-6 space-y-4">
                            <div>
                                <label for="m3u-url-input" class="block text-sm font-medium text-[var(--text-muted-color)] mb-2">Playlist URL (.m3u, .m3u8)</label>
                                <input type="url" id="m3u-url-input" placeholder="Enter M3U playlist URL" class="w-full p-2 bg-[var(--surface-color)] border border-[var(--border-color)] rounded-md focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]">
                            </div>
                            <div>
                                <label for="epg-url-input" class="block text-sm font-medium text-[var(--text-muted-color)] mb-2">EPG URL (.xml, .xml.gz - Optional)</label>
                                <input type="url" id="epg-url-input" placeholder="Enter XMLTV EPG URL" class="w-full p-2 bg-[var(--surface-color)] border border-[var(--border-color)] rounded-md focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]">
                            </div>
                            <div class="text-center text-[var(--text-muted-color)]">OR UPLOAD LOCAL FILE</div>
                             <div>
                                <label for="m3u-file-input" class="block text-sm font-medium text-[var(--text-muted-color)] mb-2">Playlist File (.m3u, .m3u8)</label>
                                <input type="file" id="m3u-file-input" accept=".m3u,.m3u8" class="w-full text-sm text-[var(--text-color)] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--accent-color)] file:text-[var(--play-button-text)] hover:file:opacity-90">
                            </div>
                        </div>
                         <footer class="p-4 border-t border-[var(--border-color)]">
                            <button id="load-playlist-btn" class="w-full p-3 bg-[var(--play-button-bg)] text-[var(--play-button-text)] rounded-lg font-bold hover:opacity-90 flex items-center justify-center">
                                <span class="button-text">Load</span>
                                <div class="loader-dots hidden ml-2">
                                    <div class="w-2 h-2 bg-white rounded-full"></div>
                                    <div class="w-2 h-2 bg-white rounded-full"></div>
                                    <div class="w-2 h-2 bg-white rounded-full"></div>
                                </div>
                            </button>
                         </footer>
                    </div>
                </div>
                <div id="options-modal" class="hidden fixed inset-0 z-50">
                    <div id="options-backdrop" class="absolute inset-0 bg-black/50 transition-opacity duration-300 opacity-0"></div>
                    <div id="options-panel" class="absolute inset-y-0 right-0 w-full max-w-sm bg-[var(--modal-bg)] flex flex-col transform translate-x-full transition-transform duration-300 ease-in-out">
                        <header class="flex items-center justify-between p-4 border-b border-[var(--border-color)] flex-shrink-0">
                            <h2 class="text-xl font-bold text-[var(--text-color)]">Options</h2>
                            <button id="close-options-button" class="p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-color)]">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </header>
                        <div id="options-container" class="p-4 space-y-3 text-[var(--text-color)] flex-grow overflow-y-auto station-list-scrollbar">
                             <button id="toggle-station-list-button" class="w-full flex justify-between items-center p-3 bg-[var(--surface-color)] hover:bg-[var(--border-color)] rounded-lg">
                                <span>Channel List</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                            </button>
                            <div id="station-list-in-options" class="station-list-scrollbar space-y-2 pr-2">
                                <p class='text-center text-sm text-[var(--text-muted-color)] p-4'>Load a playlist to see channels.</p>
                            </div>
                            <button id="random-station-button" class="w-full flex justify-between items-center p-3 bg-[var(--surface-color)] hover:bg-[var(--border-color)] rounded-lg">
                                <span>Random Channel</span>
                                <i data-lucide="dice-5" class="w-5 h-5"></i>
                            </button>
                            <button id="theme-toggle-button" class="w-full flex justify-between items-center p-3 bg-[var(--surface-color)] hover:bg-[var(--border-color)] rounded-lg">
                                <span>Toggle Theme</span>
                                <span id="theme-icon-container"><i data-lucide="moon" class="w-5 h-5"></i></span>
                            </button>
                            <button id="fullscreen-toggle-button" class="w-full flex justify-between items-center p-3 bg-[var(--surface-color)] hover:bg-[var(--border-color)] rounded-lg">
                                <span>Fullscreen</span>
                                <span id="fullscreen-icon-container"><i data-lucide="maximize" class="w-5 h-5"></i></span>
                            </button>
                            <div class="w-full grid grid-cols-2 gap-2 items-center p-3 bg-[var(--surface-color)] rounded-lg text-sm">
                                <span class="text-left">Stream Time</span>
                                <span id="stopwatch-display" class="font-mono text-right">00:00</span>
                            </div>
                        </div>
                         <div id="version-footer" class="text-center text-[var(--text-faint-color)] text-xs p-4 border-t border-[var(--border-color)] flex-shrink-0"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONSTANTS & DOM ELEMENTS ---
        const dom = {
            appContainer: document.getElementById('app-container'),
            body: document.body,
            playerDisplay: document.getElementById('player-display'),
            playerContent: document.getElementById('player-content'),
            ambientBg: document.getElementById('ambient-bg'),
            playButton: document.getElementById('play-button'),
            stopButton: document.getElementById('stop-button'),
            optionsButton: document.getElementById('options-button'),
            loadM3uButton: document.getElementById('load-m3u-button'),
            bottomBarStationName: document.getElementById('bottom-bar-station-name'),
            tunerContent: document.getElementById('tuner-content'),
            stopwatchDisplay: document.getElementById('stopwatch-display'),
            optionsModal: document.getElementById('options-modal'),
            optionsBackdrop: document.getElementById('options-backdrop'),
            optionsPanel: document.getElementById('options-panel'),
            closeOptionsButton: document.getElementById('close-options-button'),
            m3uModal: document.getElementById('m3u-modal'),
            m3uBackdrop: document.getElementById('m3u-backdrop'),
            m3uPanel: document.getElementById('m3u-panel'),
            closeM3uButton: document.getElementById('close-m3u-button'),
            m3uUrlInput: document.getElementById('m3u-url-input'),
            epgUrlInput: document.getElementById('epg-url-input'),
            m3uFileInput: document.getElementById('m3u-file-input'),
            loadPlaylistBtn: document.getElementById('load-playlist-btn'),
            toggleStationListButton: document.getElementById('toggle-station-list-button'),
            stationListInOptions: document.getElementById('station-list-in-options'),
            randomStationButton: document.getElementById('random-station-button'),
            themeToggleButton: document.getElementById('theme-toggle-button'),
            themeIconContainer: document.getElementById('theme-icon-container'),
            fullscreenToggleButton: document.getElementById('fullscreen-toggle-button'),
            fullscreenIconContainer: document.getElementById('fullscreen-icon-container'),
            versionFooter: document.getElementById('version-footer'),
            statusLeft: document.getElementById('status-left'),
            statusCenter: document.getElementById('status-center'),
            statusRight: document.getElementById('status-right'),
        };

        let state = {
            channels: [],
            epgData: {},
            currentChannelIndex: null,
            isPlaying: false,
            elapsedTime: 0,
            stopwatchInterval: null,
            epgUpdateInterval: null,
            hls: null
        };
        
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- M3U & EPG PARSING ---
        const parseM3U = (data) => {
            const lines = data.split('\n');
            const channels = [];
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    const infoLine = lines[i];
                    const urlLine = lines[++i];
                    const nameMatch = infoLine.match(/,(.+)$/);
                    const logoMatch = infoLine.match(/tvg-logo="([^"]+)"/);
                    const idMatch = infoLine.match(/tvg-id="([^"]+)"/);
                    if (nameMatch && urlLine && !urlLine.startsWith('#')) {
                        channels.push({
                            id: idMatch ? idMatch[1] : null,
                            logo: logoMatch ? logoMatch[1] : 'https://placehold.co/40x40/1a1a1a/ffffff?text=CH',
                            name: nameMatch[1].trim(),
                            url: urlLine.trim()
                        });
                    }
                }
            }
            return channels;
        };
        
        const parseEpgTime = (timeStr) => {
            // Format: YYYYMMDDHHMMSS +/-ZZZZ
            const year = parseInt(timeStr.substring(0, 4));
            const month = parseInt(timeStr.substring(4, 6)) - 1;
            const day = parseInt(timeStr.substring(6, 8));
            const hour = parseInt(timeStr.substring(8, 10));
            const minute = parseInt(timeStr.substring(10, 12));
            return new Date(Date.UTC(year, month, day, hour, minute));
        };

        const parseEPG = (xmlString) => {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            const programs = xmlDoc.getElementsByTagName('programme');
            const epg = {};
            for (const program of programs) {
                const channelId = program.getAttribute('channel');
                const title = program.getElementsByTagName('title')[0]?.textContent;
                const start = program.getAttribute('start');
                const stop = program.getAttribute('stop');
                if (channelId && title && start && stop) {
                    if (!epg[channelId]) epg[channelId] = [];
                    epg[channelId].push({
                        title: title,
                        start: parseEpgTime(start),
                        stop: parseEpgTime(stop)
                    });
                }
            }
            // Sort programs by start time
            for(const channelId in epg) epg[channelId].sort((a,b) => a.start - b.start);
            return epg;
        };

        const fetchWithProxy = async (url) => {
            // Using AllOrigins as a more reliable CORS proxy
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`);
            return response.text();
        };

        const loadPlaylistAndEPG = async () => {
            const m3uUrl = dom.m3uUrlInput.value.trim();
            const epgUrl = dom.epgUrlInput.value.trim();
            const file = dom.m3uFileInput.files[0];
            
            if (!m3uUrl && !file) {
                alert("Please provide a playlist URL or select a file.");
                return;
            }

            const loadBtn = dom.loadPlaylistBtn;
            loadBtn.classList.add('loading');
            loadBtn.disabled = true;
            loadBtn.querySelector('.button-text').textContent = 'Loading...';
            loadBtn.querySelector('.loader-dots').style.display = 'flex';

            try {
                // 1. Load and parse M3U
                let m3uContent = '';
                if (file) {
                    m3uContent = await file.text();
                } else {
                    m3uContent = await fetchWithProxy(m3uUrl);
                }
                state.channels = parseM3U(m3uContent);
                if (state.channels.length === 0) {
                    throw new Error("No channels found in the playlist.");
                }
                populateChannelList();

                // 2. Load and parse EPG (if URL is provided)
                if (epgUrl) {
                    loadBtn.querySelector('.button-text').textContent = 'Loading EPG...';
                    const xmlContent = await fetchWithProxy(epgUrl);
                    state.epgData = parseEPG(xmlContent);
                }

                alert(`Loaded ${state.channels.length} channels. EPG data ${epgUrl ? 'loaded' : 'not provided'}.`);
                closeM3uModal();

            } catch (error) {
                console.error("Load Error:", error);
                alert(`Failed to load: ${error.message}`);
            } finally {
                loadBtn.classList.remove('loading');
                loadBtn.disabled = false;
                loadBtn.querySelector('.button-text').textContent = 'Load';
                loadBtn.querySelector('.loader-dots').style.display = 'none';
            }
        };

        const populateChannelList = () => {
             if (state.channels.length === 0) {
                dom.stationListInOptions.innerHTML = `<p class='text-center text-sm text-[var(--text-muted-color)] p-4'>Load a playlist to see channels.</p>`;
                return;
            }
            dom.stationListInOptions.innerHTML = state.channels.map((channel, index) => {
                return `<div data-channel-index="${index}" class="station-item flex items-center p-3 space-x-4 cursor-pointer hover:bg-[var(--border-color)] rounded-lg transition-colors duration-200">
                            <img src="${channel.logo}" class="w-10 h-10 object-contain bg-black/10 p-1 rounded-md flex-shrink-0" onerror="this.onerror=null; this.src='https://placehold.co/40x40/1a1a1a/ffffff?text=CH'; this.style.backgroundColor='transparent';">
                            <div class="flex-grow truncate"><p class="font-bold text-[var(--text-color)]">${channel.name}</p></div>
                        </div>`;
            }).join('');
            
            dom.stationListInOptions.querySelectorAll('.station-item').forEach(item => {
                item.onclick = () => selectChannel(parseInt(item.dataset.channelIndex));
            });
        };

        // --- PLAYER LOGIC ---
        const selectChannel = (index) => {
            if (state.isPlaying && state.currentChannelIndex === index) return;
            if (state.isPlaying) stopPlayer(false).then(() => playChannel(index));
            else playChannel(index);
        };

        const playChannel = (index) => {
            if (index == null || index < 0 || index >= state.channels.length) return;
            
            state.currentChannelIndex = index;
            const channel = state.channels[index];
            
            document.querySelectorAll('.station-item').forEach(item => {
                item.classList.remove('selected');
                if (parseInt(item.dataset.channelIndex) === index) item.classList.add('selected');
            });

            dom.ambientBg.style.backgroundImage = `url(${channel.logo})`;
            dom.ambientBg.style.opacity = 1;

            const video = document.createElement('video');
            video.id = 'video-player';
            video.controls = true;
            video.autoplay = true;
            video.playsInline = true;

            dom.playerContent.innerHTML = '';
            dom.playerContent.appendChild(video);

            if (Hls.isSupported() && channel.url.includes('.m3u8')) {
                if(state.hls) state.hls.destroy();
                state.hls = new Hls();
                state.hls.loadSource(channel.url);
                state.hls.attachMedia(video);
                state.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                 video.src = channel.url;
                 video.addEventListener('canplay', () => video.play());
            }
            
            video.onplay = handlePlay;
            video.onpause = handlePause;
            video.onerror = (e) => {
                console.error("Video Error:", e);
                stopPlayer(true);
                alert("Error playing this channel.");
            };
            
            closeOptions();
        };
        
        const handlePlay = () => {
            state.isPlaying = true;
            updateControlButtons();
            updateTunerDisplay();
            updateMediaSession();
            dom.bottomBarStationName.textContent = "Now Playing: " + state.channels[state.currentChannelIndex].name;
            
            clearInterval(state.stopwatchInterval);
            state.elapsedTime = 0;
            updateStopwatch();
            state.stopwatchInterval = setInterval(() => { state.elapsedTime++; updateStopwatch(); }, 1000);

            clearInterval(state.epgUpdateInterval);
            state.epgUpdateInterval = setInterval(updateTunerDisplay, 60000); // Refresh EPG every minute
        };

        const handlePause = () => {
            state.isPlaying = false;
            updateControlButtons();
            dom.bottomBarStationName.textContent = "Paused";
            clearInterval(state.stopwatchInterval);
            clearInterval(state.epgUpdateInterval);
        };

        const stopPlayer = async (withAnimation = true) => {
            dom.ambientBg.style.opacity = 0;
            if (state.hls) { state.hls.destroy(); state.hls = null; }

            const video = document.getElementById('video-player');
            if(video) { video.pause(); video.removeAttribute('src'); video.load(); }

            state.isPlaying = false;
            if (withAnimation) {
                dom.playerContent.style.transition = 'opacity 0.3s ease-out';
                dom.playerContent.style.opacity = 0;
                await delay(300);
                dom.playerContent.innerHTML = `<i data-lucide="tv" class="w-16 h-16 text-[var(--text-faint-color)]"></i>`;
                lucide.createIcons();
                dom.playerContent.style.opacity = 1;
            } else {
                 dom.playerContent.innerHTML = `<i data-lucide="tv" class="w-16 h-16 text-[var(--text-faint-color)]"></i>`;
                 lucide.createIcons();
            }

            state.currentChannelIndex = null;
            updateControlButtons();
            updateTunerDisplay();
            
            clearInterval(state.stopwatchInterval);
            clearInterval(state.epgUpdateInterval);
            state.elapsedTime = 0;
            updateStopwatch();
            dom.bottomBarStationName.textContent = "Standby";
            document.querySelectorAll('.station-item').forEach(item => item.classList.remove('selected'));
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = "none";
                navigator.mediaSession.metadata = null;
            }
        };

        const togglePlay = () => {
            if (state.currentChannelIndex === null) {
                openOptions();
                 const list = dom.stationListInOptions;
                if (!list.classList.contains('expanded')) {
                    list.classList.add('expanded');
                    const icon = dom.toggleStationListButton.querySelector('svg');
                    if (icon) icon.classList.add('rotate-180');
                }
                return;
            }
            const video = document.getElementById('video-player');
            if (video) video.paused ? video.play() : video.pause();
        };

        // --- UI, EPG & UX ---
        const getCurrentProgram = (channelId) => {
            if (!channelId || !state.epgData[channelId]) return null;
            const now = new Date();
            return state.epgData[channelId].find(p => now >= p.start && now < p.stop);
        };

        const updateTunerDisplay = () => {
            const channel = state.channels[state.currentChannelIndex];
            if (channel && state.isPlaying) {
                const program = getCurrentProgram(channel.id);
                const epgText = program ? ` | ${program.title}` : '';
                dom.tunerContent.innerHTML = `
                    <div class="video-mode">
                        <i data-lucide="tv" class="w-5 h-5"></i>
                        <span class="font-bold text-sm truncate">${channel.name}${epgText}</span>
                    </div>`;
                dom.tunerContent.style.opacity = 1;
            } else {
                dom.tunerContent.style.opacity = 0;
                dom.tunerContent.innerHTML = '';
            }
            lucide.createIcons();
        };
        
        const updateControlButtons = () => { if (state.isPlaying) { dom.playButton.classList.add('hidden'); dom.stopButton.classList.remove('hidden'); } else { dom.playButton.classList.remove('hidden'); dom.stopButton.classList.add('hidden'); } lucide.createIcons(); };
        const updateStopwatch = () => { const h = Math.floor(state.elapsedTime / 3600), m = Math.floor((state.elapsedTime % 3600) / 60), s = state.elapsedTime % 60, pad = (num) => String(num).padStart(2, '0'); dom.stopwatchDisplay.textContent = h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`; };
        const updateStatusBar = () => { const now = new Date(), timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); dom.statusLeft.innerHTML = `<span class="font-bold text-sm">GLZ Player</span>`; dom.statusCenter.innerHTML = timeString; dom.statusRight.innerHTML = `<i data-lucide="${navigator.onLine ? 'wifi' : 'wifi-off'}" class="w-5 h-5 ${!navigator.onLine ? 'text-red-500' : ''}"></i>`; lucide.createIcons(); };
        const updateMediaSession = () => { if ('mediaSession' in navigator && state.currentChannelIndex !== null) { const channel = state.channels[state.currentChannelIndex], program = getCurrentProgram(channel.id); navigator.mediaSession.metadata = new MediaMetadata({ title: channel.name, artist: program ? program.title : 'Glz Player', artwork: [{ src: channel.logo, sizes: '512x512', type: 'image/png' }] }); } };
        const openOptions = () => { dom.appContainer.classList.add('options-open'); dom.optionsModal.classList.remove('hidden'); requestAnimationFrame(() => dom.optionsModal.classList.add('is-open')); };
        const closeOptions = () => { dom.appContainer.classList.remove('options-open'); dom.optionsModal.classList.remove('is-open'); const list = dom.stationListInOptions; if (list.classList.contains('expanded')) { list.classList.remove('expanded'); const icon = dom.toggleStationListButton.querySelector('svg'); if (icon) icon.classList.remove('rotate-180'); } };
        const openM3uModal = () => { dom.m3uModal.classList.remove('hidden'); requestAnimationFrame(() => dom.m3uModal.classList.add('is-open')); };
        const closeM3uModal = () => { dom.m3uModal.classList.remove('is-open'); };
        const toggleFullScreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => console.error(`Fullscreen Error: ${err.message}`)); else if (document.exitFullscreen) document.exitFullscreen(); };
        const updateFullscreenIcon = () => { const iconContainer = dom.fullscreenIconContainer; if (document.fullscreenElement) iconContainer.innerHTML = `<i data-lucide="minimize" class="w-5 h-5"></i>`; else iconContainer.innerHTML = `<i data-lucide="maximize" class="w-5 h-5"></i>`; lucide.createIcons(); };
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        const setupEventListeners = () => {
            dom.optionsButton.onclick = openOptions;
            dom.closeOptionsButton.onclick = closeOptions;
            dom.optionsBackdrop.onclick = closeOptions;
            dom.optionsPanel.addEventListener('transitionend', () => { if (!dom.optionsModal.classList.contains('is-open')) dom.optionsModal.classList.add('hidden'); });
            dom.loadM3uButton.onclick = openM3uModal;
            dom.closeM3uButton.onclick = closeM3uModal;
            dom.m3uBackdrop.onclick = closeM3uModal;
            dom.m3uPanel.addEventListener('transitionend', () => { if (!dom.m3uModal.classList.contains('is-open')) dom.m3uModal.classList.add('hidden'); });
            dom.loadPlaylistBtn.onclick = loadPlaylistAndEPG;
            dom.playButton.onclick = togglePlay;
            dom.stopButton.onclick = () => stopPlayer(true);
            dom.toggleStationListButton.onclick = () => { const list = dom.stationListInOptions, icon = dom.toggleStationListButton.querySelector('svg'); list.classList.toggle('expanded'); if (icon) icon.classList.toggle('rotate-180'); };
            dom.randomStationButton.onclick = () => { if(state.channels.length === 0) { alert("Please load a channel list first."); return; } const randomIndex = Math.floor(Math.random() * state.channels.length); selectChannel(randomIndex); };
            dom.fullscreenToggleButton.onclick = toggleFullScreen;
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
             if ('mediaSession' in navigator) { navigator.mediaSession.setActionHandler('play', togglePlay); navigator.mediaSession.setActionHandler('pause', togglePlay); navigator.mediaSession.setActionHandler('stop', () => stopPlayer(true)); }
        };

        const setupTheming = () => {
            const themes = ['dark', 'light', 'oled']; let currentThemeIndex = 0; const savedTheme = localStorage.getItem('glz-player-theme'); if (savedTheme && themes.includes(savedTheme)) currentThemeIndex = themes.indexOf(savedTheme);
            const applyTheme = (themeName) => { dom.body.classList.remove('theme-light', 'theme-dark', 'theme-oled'); if (themeName !== 'dark') dom.body.classList.add(`theme-${themeName}`); dom.themeIconContainer.innerHTML = `<i data-lucide="${themeName === 'light' ? 'moon' : 'sun'}" class="w-5 h-5"></i>`; lucide.createIcons(); localStorage.setItem('glz-player-theme', themeName); const themeAccentColor = getComputedStyle(dom.body).getPropertyValue('--play-button-bg').trim(); dom.appContainer.style.setProperty('--accent-color', themeAccentColor); };
            applyTheme(themes[currentThemeIndex]); dom.themeToggleButton.onclick = () => { currentThemeIndex = (currentThemeIndex + 1) % themes.length; applyTheme(themes[currentThemeIndex]); };
        };

        const init = () => {
            lucide.createIcons();
            setTimeout(() => { document.getElementById('splash-screen').style.cssText = 'opacity: 0; visibility: hidden;'; }, 1500);
            updateStatusBar(); setInterval(updateStatusBar, 10000);
            updateControlButtons();
            setupEventListeners();
            setupTheming();
            updateTunerDisplay(null);
            populateChannelList();
            dom.bottomBarStationName.textContent = "Standby";
            dom.versionFooter.innerHTML = `<p>® ©Glz Technical Services | Ver: 10.1 | Build: ${new Date().toISOString().slice(0, 10).replace(/-/g,'.')}</p>`;
        };

        init();
    </script>
</body>
</html>
